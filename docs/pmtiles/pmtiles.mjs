/* esm.sh - pmtiles@3.2.0 */
var M=Math.pow,g=(e,t,r)=>new Promise((n,i)=>{var a=u=>{try{c(r.next(u))}catch(f){i(f)}},o=u=>{try{c(r.throw(u))}catch(f){i(f)}},c=u=>u.done?n(u.value):Promise.resolve(u.value).then(a,o);c((r=r.apply(e,t)).next())}),w=Uint8Array,B=Uint16Array,Ke=Int32Array,ye=new w([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),me=new w([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Se=new w([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),pe=function(e,t){for(var r=new B(31),n=0;n<31;++n)r[n]=t+=1<<e[n-1];for(var i=new Ke(r[30]),n=1;n<30;++n)for(var a=r[n];a<r[n+1];++a)i[a]=a-r[n]<<5|n;return{b:r,r:i}},we=pe(ye,2),xe=we.b,Pe=we.r;xe[28]=258,Pe[258]=28;var Ue=pe(me,0),Re=Ue.b,Dt=Ue.r,X=new B(32768);for(h=0;h<32768;++h)z=(h&43690)>>1|(h&21845)<<1,z=(z&52428)>>2|(z&13107)<<2,z=(z&61680)>>4|(z&3855)<<4,X[h]=((z&65280)>>8|(z&255)<<8)>>1;var z,h,K=function(e,t,r){for(var n=e.length,i=0,a=new B(t);i<n;++i)e[i]&&++a[e[i]-1];var o=new B(t);for(i=1;i<t;++i)o[i]=o[i-1]+a[i-1]<<1;var c;if(r){c=new B(1<<t);var u=15-t;for(i=0;i<n;++i)if(e[i])for(var f=i<<4|e[i],s=t-e[i],l=o[e[i]-1]++<<s,d=l|(1<<s)-1;l<=d;++l)c[X[l]>>u]=f}else for(c=new B(n),i=0;i<n;++i)e[i]&&(c[i]=X[o[e[i]-1]++]>>15-e[i]);return c},S=new w(288);for(h=0;h<144;++h)S[h]=8;var h;for(h=144;h<256;++h)S[h]=9;var h;for(h=256;h<280;++h)S[h]=7;var h;for(h=280;h<288;++h)S[h]=8;var h,De=new w(32);for(h=0;h<32;++h)De[h]=5;var h,ke=K(S,9,1),Ie=K(De,5,1),G=function(e){for(var t=e[0],r=1;r<e.length;++r)e[r]>t&&(t=e[r]);return t},b=function(e,t,r){var n=t/8|0;return(e[n]|e[n+1]<<8)>>(t&7)&r},Y=function(e,t){var r=t/8|0;return(e[r]|e[r+1]<<8|e[r+2]<<16)>>(t&7)},_e=function(e){return(e+7)/8|0},je=function(e,t,r){(t==null||t<0)&&(t=0),(r==null||r>e.length)&&(r=e.length);var n=new w(r-t);return n.set(e.subarray(t,r)),n},We=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],p=function(e,t,r){var n=new Error(t||We[e]);if(n.code=e,Error.captureStackTrace&&Error.captureStackTrace(n,p),!r)throw n;return n},te=function(e,t,r,n){var i=e.length,a=n?n.length:0;if(!i||t.f&&!t.l)return r||new w(0);var o=!r||t.i!=2,c=t.i;r||(r=new w(i*3));var u=function(ue){var fe=r.length;if(ue>fe){var he=new w(Math.max(fe*2,ue));he.set(r),r=he}},f=t.f||0,s=t.p||0,l=t.b||0,d=t.l,m=t.d,v=t.m,U=t.n,T=i*8;do{if(!d){f=b(e,s,1);var P=b(e,s+1,3);if(s+=3,P)if(P==1)d=ke,m=Ie,v=9,U=5;else if(P==2){var j=b(e,s,31)+257,ne=b(e,s+10,15)+4,ie=j+b(e,s+5,31)+1;s+=14;for(var V=new w(ie),W=new w(19),x=0;x<ne;++x)W[Se[x]]=b(e,s+x*3,7);s+=ne*3;for(var ae=G(W),Be=(1<<ae)-1,Ve=K(W,ae,1),x=0;x<ie;){var oe=Ve[b(e,s,Be)];s+=oe&15;var y=oe>>4;if(y<16)V[x++]=y;else{var A=0,R=0;for(y==16?(R=3+b(e,s,3),s+=2,A=V[x-1]):y==17?(R=3+b(e,s,7),s+=3):y==18&&(R=11+b(e,s,127),s+=7);R--;)V[x++]=A}}var se=V.subarray(0,j),D=V.subarray(j);v=G(se),U=G(D),d=K(se,v,1),m=K(D,U,1)}else p(1);else{var y=_e(s)+4,I=e[y-4]|e[y-3]<<8,_=y+I;if(_>i){c&&p(0);break}o&&u(l+I),r.set(e.subarray(y,_),l),t.b=l+=I,t.p=s=_*8,t.f=f;continue}if(s>T){c&&p(0);break}}o&&u(l+131072);for(var Ze=(1<<v)-1,He=(1<<U)-1,N=s;;N=s){var A=d[Y(e,s)&Ze],C=A>>4;if(s+=A&15,s>T){c&&p(0);break}if(A||p(2),C<256)r[l++]=C;else if(C==256){N=s,d=null;break}else{var ce=C-254;if(C>264){var x=C-257,Z=ye[x];ce=b(e,s,(1<<Z)-1)+xe[x],s+=Z}var J=m[Y(e,s)&He],F=J>>4;J||p(3),s+=J&15;var D=Re[F];if(F>3){var Z=me[F];D+=Y(e,s)&(1<<Z)-1,s+=Z}if(s>T){c&&p(0);break}o&&u(l+131072);var q=l+ce;if(l<D){var le=a-D,Oe=Math.min(D,q);for(le+l<0&&p(3);l<Oe;++l)r[l]=n[le+l]}for(;l<q;l+=4)r[l]=r[l-D],r[l+1]=r[l+1-D],r[l+2]=r[l+2-D],r[l+3]=r[l+3-D];l=q}}t.l=d,t.p=N,t.b=l,t.f=f,d&&(f=1,t.m=v,t.d=m,t.n=U)}while(!f);return l==r.length?r:je(r,0,l)},Ne=new w(0),Je=function(e){(e[0]!=31||e[1]!=139||e[2]!=8)&&p(6,"invalid gzip data");var t=e[3],r=10;t&4&&(r+=(e[10]|e[11]<<8)+2);for(var n=(t>>3&1)+(t>>4&1);n>0;n-=!e[r++]);return r+(t&2)},Fe=function(e){var t=e.length;return(e[t-4]|e[t-3]<<8|e[t-2]<<16|e[t-1]<<24)>>>0},qe=function(e,t){return((e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31)&&p(6,"invalid zlib data"),(e[1]>>5&1)==+!t&&p(6,"invalid zlib data: "+(e[1]&32?"need":"unexpected")+" dictionary"),(e[1]>>3&4)+2};function Ge(e,t){return te(e,{i:2},t&&t.out,t&&t.dictionary)}function Ye(e,t){var r=Je(e);return r+8>e.length&&p(6,"invalid gzip data"),te(e.subarray(r,-8),{i:2},t&&t.out||new w(Fe(e)),t&&t.dictionary)}function Xe(e,t){return te(e.subarray(qe(e,t&&t.dictionary),-4),{i:2},t&&t.out,t&&t.dictionary)}function Q(e,t){return e[0]==31&&e[1]==139&&e[2]==8?Ye(e,t):(e[0]&15)!=8||e[0]>>4>7||(e[0]<<8|e[1])%31?Ge(e,t):Xe(e,t)}var Qe=typeof TextDecoder<"u"&&new TextDecoder,et=0;try{Qe.decode(Ne,{stream:!0}),et=1}catch{}var be=(e,t)=>e*M(2,t),H=(e,t)=>Math.floor(e/M(2,t)),k=(e,t)=>be(e.getUint16(t+1,!0),8)+e.getUint8(t),Le=(e,t)=>be(e.getUint32(t+2,!0),16)+e.getUint16(t,!0),tt=(e,t,r,n,i)=>{if(e!==n.getUint8(i))return e-n.getUint8(i);let a=k(n,i+1);if(t!==a)return t-a;let o=k(n,i+4);return r!==o?r-o:0},rt=(e,t,r,n)=>{let i=Ee(e,t|128,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],isDir:!0}:null},de=(e,t,r,n)=>{let i=Ee(e,t,r,n);return i?{z:t,x:r,y:n,offset:i[0],length:i[1],isDir:!1}:null},Ee=(e,t,r,n)=>{let i=0,a=e.byteLength/17-1;for(;i<=a;){let o=a+i>>1,c=tt(t,r,n,e,o*17);if(c>0)i=o+1;else if(c<0)a=o-1;else return[Le(e,o*17+7),e.getUint32(o*17+13,!0)]}return null},nt=(e,t)=>e.isDir&&!t.isDir?1:!e.isDir&&t.isDir?-1:e.z!==t.z?e.z-t.z:e.x!==t.x?e.x-t.x:e.y-t.y,ze=(e,t)=>{let r=e.getUint8(t*17);return{z:r&127,x:k(e,t*17+1),y:k(e,t*17+4),offset:Le(e,t*17+7),length:e.getUint32(t*17+13,!0),isDir:r>>7===1}},ge=e=>{let t=[],r=new DataView(e);for(let n=0;n<r.byteLength/17;n++)t.push(ze(r,n));return it(t)},it=e=>{e.sort(nt);let t=new ArrayBuffer(17*e.length),r=new Uint8Array(t);for(let n=0;n<e.length;n++){let i=e[n],a=i.z;i.isDir&&(a=a|128),r[n*17]=a,r[n*17+1]=i.x&255,r[n*17+2]=i.x>>8&255,r[n*17+3]=i.x>>16&255,r[n*17+4]=i.y&255,r[n*17+5]=i.y>>8&255,r[n*17+6]=i.y>>16&255,r[n*17+7]=i.offset&255,r[n*17+8]=H(i.offset,8)&255,r[n*17+9]=H(i.offset,16)&255,r[n*17+10]=H(i.offset,24)&255,r[n*17+11]=H(i.offset,32)&255,r[n*17+12]=H(i.offset,48)&255,r[n*17+13]=i.length&255,r[n*17+14]=i.length>>8&255,r[n*17+15]=i.length>>16&255,r[n*17+16]=i.length>>24&255}return t},at=(e,t)=>{if(e.byteLength<17)return null;let r=e.byteLength/17,n=ze(e,r-1);if(n.isDir){let i=n.z,a=t.z-i,o=Math.trunc(t.x/(1<<a)),c=Math.trunc(t.y/(1<<a));return{z:i,x:o,y:c}}return null};function ot(e){return g(this,null,function*(){let t=yield e.getBytes(0,512e3),r=new DataView(t.data),n=r.getUint32(4,!0),i=r.getUint16(8,!0),a=new TextDecoder("utf-8"),o=JSON.parse(a.decode(new DataView(t.data,10,n))),c=0;o.compression==="gzip"&&(c=2);let u=0;"minzoom"in o&&(u=+o.minzoom);let f=0;"maxzoom"in o&&(f=+o.maxzoom);let s=0,l=0,d=0,m=-180,v=-85,U=180,T=85;if(o.bounds){let y=o.bounds.split(",");m=+y[0],v=+y[1],U=+y[2],T=+y[3]}if(o.center){let y=o.center.split(",");s=+y[0],l=+y[1],d=+y[2]}return{specVersion:r.getUint16(2,!0),rootDirectoryOffset:10+n,rootDirectoryLength:i*17,jsonMetadataOffset:10,jsonMetadataLength:n,leafDirectoryOffset:0,leafDirectoryLength:void 0,tileDataOffset:0,tileDataLength:void 0,numAddressedTiles:0,numTileEntries:0,numTileContents:0,clustered:!1,internalCompression:1,tileCompression:c,tileType:1,minZoom:u,maxZoom:f,minLon:m,minLat:v,maxLon:U,maxLat:T,centerZoom:d,centerLon:s,centerLat:l,etag:t.etag}})}function st(e,t,r,n,i,a,o){return g(this,null,function*(){let c=yield r.getArrayBuffer(t,e.rootDirectoryOffset,e.rootDirectoryLength,e);e.specVersion===1&&(c=ge(c));let u=de(new DataView(c),n,i,a);if(u){let l=(yield t.getBytes(u.offset,u.length,o)).data,d=new DataView(l);return d.getUint8(0)===31&&d.getUint8(1)===139&&(l=Q(new Uint8Array(l))),{data:l}}let f=at(new DataView(c),{z:n,x:i,y:a});if(f){let s=rt(new DataView(c),f.z,f.x,f.y);if(s){let l=yield r.getArrayBuffer(t,s.offset,s.length,e);e.specVersion===1&&(l=ge(l));let d=de(new DataView(l),n,i,a);if(d){let v=(yield t.getBytes(d.offset,d.length,o)).data,U=new DataView(v);return U.getUint8(0)===31&&U.getUint8(1)===139&&(v=Q(new Uint8Array(v))),{data:v}}}}})}var Me={getHeader:ot,getZxy:st},bt=(e,t)=>{let r=!1,n="",i=L.GridLayer.extend({createTile:(a,o)=>{let c=document.createElement("img"),u=new AbortController,f=u.signal;return c.cancel=()=>{u.abort()},r||(e.getHeader().then(s=>{s.tileType===1?console.error("Error: archive contains MVT vector tiles, but leafletRasterLayer is for displaying raster tiles. See https://github.com/protomaps/PMTiles/tree/main/js for details."):s.tileType===2?n="image/png":s.tileType===3?n="image/jpeg":s.tileType===4?n="image/webp":s.tileType===5&&(n="image/avif")}),r=!0),e.getZxy(a.z,a.x,a.y,f).then(s=>{if(s){let l=new Blob([s.data],{type:n}),d=window.URL.createObjectURL(l);c.src=d,c.cancel=void 0,o(void 0,c)}}).catch(s=>{if(s.name!=="AbortError")throw s}),c},_removeTile:function(a){let o=this._tiles[a];o&&(o.el.cancel&&o.el.cancel(),o.el.width=0,o.el.height=0,o.el.deleted=!0,L.DomUtil.remove(o.el),delete this._tiles[a],this.fire("tileunload",{tile:o.el,coords:this._keyToTileCoords(a)}))}});return new i(t)},ct=e=>(t,r)=>{if(r instanceof AbortController)return e(t,r);let n=new AbortController;return e(t,n).then(i=>r(void 0,i.data,i.cacheControl||"",i.expires||""),i=>r(i)).catch(i=>r(i)),{cancel:()=>n.abort()}},Lt=class{constructor(e){this.tilev4=(t,r)=>g(this,null,function*(){if(t.type==="json"){let d=t.url.substr(10),m=this.tiles.get(d);if(m||(m=new ve(d),this.tiles.set(d,m)),this.metadata)return{data:yield m.getTileJson(t.url)};let v=yield m.getHeader();return{data:{tiles:[`${t.url}/{z}/{x}/{y}`],minzoom:v.minZoom,maxzoom:v.maxZoom,bounds:[v.minLon,v.minLat,v.maxLon,v.maxLat]}}}let n=new RegExp(/pmtiles:\/\/(.+)\/(\d+)\/(\d+)\/(\d+)/),i=t.url.match(n);if(!i)throw new Error("Invalid PMTiles protocol URL");let a=i[1],o=this.tiles.get(a);o||(o=new ve(a),this.tiles.set(a,o));let c=i[2],u=i[3],f=i[4],s=yield o.getHeader(),l=yield o?.getZxy(+c,+u,+f,r.signal);return l?{data:new Uint8Array(l.data),cacheControl:l.cacheControl,expires:l.expires}:s.tileType===1?{data:new Uint8Array}:{data:null}}),this.tile=ct(this.tilev4),this.tiles=new Map,this.metadata=e?.metadata||!1}add(e){this.tiles.set(e.source.getKey(),e)}get(e){return this.tiles.get(e)}};function $(e,t){return(t>>>0)*4294967296+(e>>>0)}function lt(e,t){let r=t.buf,n=r[t.pos++],i=(n&112)>>4;if(n<128||(n=r[t.pos++],i|=(n&127)<<3,n<128)||(n=r[t.pos++],i|=(n&127)<<10,n<128)||(n=r[t.pos++],i|=(n&127)<<17,n<128)||(n=r[t.pos++],i|=(n&127)<<24,n<128)||(n=r[t.pos++],i|=(n&1)<<31,n<128))return $(e,i);throw new Error("Expected varint not more than 10 bytes")}function O(e){let t=e.buf,r=t[e.pos++],n=r&127;return r<128||(r=t[e.pos++],n|=(r&127)<<7,r<128)||(r=t[e.pos++],n|=(r&127)<<14,r<128)||(r=t[e.pos++],n|=(r&127)<<21,r<128)?n:(r=t[e.pos],n|=(r&15)<<28,lt(n,e))}function Te(e,t,r,n){if(n===0){r===1&&(t[0]=e-1-t[0],t[1]=e-1-t[1]);let i=t[0];t[0]=t[1],t[1]=i}}function ut(e,t){let r=M(2,e),n=t,i=t,a=t,o=[0,0],c=1;for(;c<r;)n=1&a/2,i=1&(a^n),Te(c,o,n,i),o[0]+=c*n,o[1]+=c*i,a=a/4,c*=2;return[e,o[0],o[1]]}var ft=[0,1,5,21,85,341,1365,5461,21845,87381,349525,1398101,5592405,22369621,89478485,357913941,1431655765,5726623061,22906492245,91625968981,366503875925,1466015503701,5864062014805,23456248059221,93824992236885,375299968947541,0x5555555555555];function ht(e,t,r){if(e>26)throw Error("Tile zoom level exceeds max safe number limit (26)");if(t>M(2,e)-1||r>M(2,e)-1)throw Error("tile x/y outside zoom level bounds");let n=ft[e],i=M(2,e),a=0,o=0,c=0,u=[t,r],f=i/2;for(;f>0;)a=(u[0]&f)>0?1:0,o=(u[1]&f)>0?1:0,c+=f*f*(3*a^o),Te(f,u,a,o),f=f/2;return n+c}function Et(e){let t=0,r=0;for(let n=0;n<27;n++){let i=(1<<n)*(1<<n);if(t+i>e)return ut(n,e-t);t+=i}throw Error("Tile zoom level exceeds max safe number limit (26)")}var dt=(e=>(e[e.Unknown=0]="Unknown",e[e.None=1]="None",e[e.Gzip=2]="Gzip",e[e.Brotli=3]="Brotli",e[e.Zstd=4]="Zstd",e))(dt||{});function re(e,t){return g(this,null,function*(){if(t===1||t===0)return e;if(t===2){if(typeof globalThis.DecompressionStream>"u")return Q(new Uint8Array(e));let r=new Response(e).body;if(!r)throw Error("Failed to read response stream");let n=r.pipeThrough(new globalThis.DecompressionStream("gzip"));return new Response(n).arrayBuffer()}throw Error("Compression method not supported")})}var gt=(e=>(e[e.Unknown=0]="Unknown",e[e.Mvt=1]="Mvt",e[e.Png=2]="Png",e[e.Jpeg=3]="Jpeg",e[e.Webp=4]="Webp",e[e.Avif=5]="Avif",e))(gt||{});function vt(e){return e===1?".mvt":e===2?".png":e===3?".jpg":e===4?".webp":e===5?".avif":""}var yt=127;function mt(e,t){let r=0,n=e.length-1;for(;r<=n;){let i=n+r>>1,a=t-e[i].tileId;if(a>0)r=i+1;else if(a<0)n=i-1;else return e[i]}return n>=0&&(e[n].runLength===0||t-e[n].tileId<e[n].runLength)?e[n]:null}var zt=class{constructor(e){this.file=e}getKey(){return this.file.name}getBytes(e,t){return g(this,null,function*(){return{data:yield this.file.slice(e,e+t).arrayBuffer()}})}},pt=class{constructor(e,t=new Headers){this.url=e,this.customHeaders=t,this.mustReload=!1;let r="";"navigator"in globalThis&&(r=globalThis.navigator.userAgent||"");let n=r.indexOf("Windows")>-1,i=/Chrome|Chromium|Edg|OPR|Brave/.test(r);this.chromeWindowsNoCache=!1,n&&i&&(this.chromeWindowsNoCache=!0)}getKey(){return this.url}setHeaders(e){this.customHeaders=e}getBytes(e,t,r,n){return g(this,null,function*(){let i,a;r?a=r:(i=new AbortController,a=i.signal);let o=new Headers(this.customHeaders);o.set("range",`bytes=${e}-${e+t-1}`);let c;this.mustReload?c="reload":this.chromeWindowsNoCache&&(c="no-store");let u=yield fetch(this.url,{signal:a,cache:c,headers:o});if(e===0&&u.status===416){let d=u.headers.get("Content-Range");if(!d||!d.startsWith("bytes */"))throw Error("Missing content-length on 416 response");let m=+d.substr(8);u=yield fetch(this.url,{signal:a,cache:"reload",headers:{range:`bytes=0-${m-1}`}})}let f=u.headers.get("Etag");if(f?.startsWith("W/")&&(f=null),u.status===416||n&&f&&f!==n)throw this.mustReload=!0,new ee(`Server returned non-matching ETag ${n} after one retry. Check browser extensions and servers for issues that may affect correct ETag headers.`);if(u.status>=300)throw Error(`Bad response code: ${u.status}`);let s=u.headers.get("Content-Length");if(u.status===200&&(!s||+s>t))throw i&&i.abort(),Error("Server returned no content-length header or content-length exceeding request. Check that your storage backend supports HTTP Byte Serving.");return{data:yield u.arrayBuffer(),etag:f||void 0,cacheControl:u.headers.get("Cache-Control")||void 0,expires:u.headers.get("Expires")||void 0}})}};function E(e,t){let r=e.getUint32(t+4,!0),n=e.getUint32(t+0,!0);return r*M(2,32)+n}function wt(e,t){let r=new DataView(e),n=r.getUint8(7);if(n>3)throw Error(`Archive is spec version ${n} but this library supports up to spec version 3`);return{specVersion:n,rootDirectoryOffset:E(r,8),rootDirectoryLength:E(r,16),jsonMetadataOffset:E(r,24),jsonMetadataLength:E(r,32),leafDirectoryOffset:E(r,40),leafDirectoryLength:E(r,48),tileDataOffset:E(r,56),tileDataLength:E(r,64),numAddressedTiles:E(r,72),numTileEntries:E(r,80),numTileContents:E(r,88),clustered:r.getUint8(96)===1,internalCompression:r.getUint8(97),tileCompression:r.getUint8(98),tileType:r.getUint8(99),minZoom:r.getUint8(100),maxZoom:r.getUint8(101),minLon:r.getInt32(102,!0)/1e7,minLat:r.getInt32(106,!0)/1e7,maxLon:r.getInt32(110,!0)/1e7,maxLat:r.getInt32(114,!0)/1e7,centerZoom:r.getUint8(118),centerLon:r.getInt32(119,!0)/1e7,centerLat:r.getInt32(123,!0)/1e7,etag:t}}function Ae(e){let t={buf:new Uint8Array(e),pos:0},r=O(t),n=[],i=0;for(let a=0;a<r;a++){let o=O(t);n.push({tileId:i+o,offset:0,length:0,runLength:1}),i+=o}for(let a=0;a<r;a++)n[a].runLength=O(t);for(let a=0;a<r;a++)n[a].length=O(t);for(let a=0;a<r;a++){let o=O(t);o===0&&a>0?n[a].offset=n[a-1].offset+n[a-1].length:n[a].offset=o-1}return n}function xt(e){let t=new DataView(e);return t.getUint16(2,!0)===2?(console.warn("PMTiles spec version 2 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),2):t.getUint16(2,!0)===1?(console.warn("PMTiles spec version 1 has been deprecated; please see github.com/protomaps/PMTiles for tools to upgrade"),1):3}var ee=class extends Error{};function Ce(e,t){return g(this,null,function*(){let r=yield e.getBytes(0,16384);if(new DataView(r.data).getUint16(0,!0)!==19792)throw new Error("Wrong magic number for PMTiles archive");if(xt(r.data)<3)return[yield Me.getHeader(e)];let i=r.data.slice(0,yt),a=wt(i,r.etag),o=r.data.slice(a.rootDirectoryOffset,a.rootDirectoryOffset+a.rootDirectoryLength),c=`${e.getKey()}|${a.etag||""}|${a.rootDirectoryOffset}|${a.rootDirectoryLength}`,u=Ae(yield t(o,a.internalCompression));return[a,[c,u.length,u]]})}function $e(e,t,r,n,i){return g(this,null,function*(){let a=yield e.getBytes(r,n,void 0,i.etag),o=yield t(a.data,i.internalCompression),c=Ae(o);if(c.length===0)throw new Error("Empty directory is invalid");return c})}var Mt=class{constructor(e=100,t=!0,r=re){this.cache=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return g(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,r.data;let n=yield Ce(e,this.decompress);return n[1]&&this.cache.set(n[1][0],{lastUsed:this.counter++,data:n[1][2]}),this.cache.set(t,{lastUsed:this.counter++,data:n[0]}),this.prune(),n[0]})}getDirectory(e,t,r,n){return g(this,null,function*(){let i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,a=this.cache.get(i);if(a)return a.lastUsed=this.counter++,a.data;let o=yield $e(e,this.decompress,t,r,n);return this.cache.set(i,{lastUsed:this.counter++,data:o}),this.prune(),o})}getArrayBuffer(e,t,r,n){return g(this,null,function*(){let i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,a=this.cache.get(i);if(a)return a.lastUsed=this.counter++,yield a.data;let o=yield e.getBytes(t,r,void 0,n.etag);return this.cache.set(i,{lastUsed:this.counter++,data:o.data}),this.prune(),o.data})}prune(){if(this.cache.size>this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return g(this,null,function*(){this.cache.delete(e.getKey())})}},Ut=class{constructor(e=100,t=!0,r=re){this.cache=new Map,this.invalidations=new Map,this.maxCacheEntries=e,this.counter=1,this.decompress=r}getHeader(e){return g(this,null,function*(){let t=e.getKey(),r=this.cache.get(t);if(r)return r.lastUsed=this.counter++,yield r.data;let n=new Promise((i,a)=>{Ce(e,this.decompress).then(o=>{o[1]&&this.cache.set(o[1][0],{lastUsed:this.counter++,data:Promise.resolve(o[1][2])}),i(o[0]),this.prune()}).catch(o=>{a(o)})});return this.cache.set(t,{lastUsed:this.counter++,data:n}),n})}getDirectory(e,t,r,n){return g(this,null,function*(){let i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,a=this.cache.get(i);if(a)return a.lastUsed=this.counter++,yield a.data;let o=new Promise((c,u)=>{$e(e,this.decompress,t,r,n).then(f=>{c(f),this.prune()}).catch(f=>{u(f)})});return this.cache.set(i,{lastUsed:this.counter++,data:o}),o})}getArrayBuffer(e,t,r,n){return g(this,null,function*(){let i=`${e.getKey()}|${n.etag||""}|${t}|${r}`,a=this.cache.get(i);if(a)return a.lastUsed=this.counter++,yield a.data;let o=new Promise((c,u)=>{e.getBytes(t,r,void 0,n.etag).then(f=>{c(f.data),this.cache.has(i),this.prune()}).catch(f=>{u(f)})});return this.cache.set(i,{lastUsed:this.counter++,data:o}),o})}prune(){if(this.cache.size>=this.maxCacheEntries){let e=1/0,t;this.cache.forEach((r,n)=>{r.lastUsed<e&&(e=r.lastUsed,t=n)}),t&&this.cache.delete(t)}}invalidate(e){return g(this,null,function*(){let t=e.getKey();if(this.invalidations.get(t))return yield this.invalidations.get(t);this.cache.delete(e.getKey());let r=new Promise((n,i)=>{this.getHeader(e).then(a=>{n(),this.invalidations.delete(t)}).catch(a=>{i(a)})});this.invalidations.set(t,r)})}},ve=class{constructor(e,t,r){typeof e=="string"?this.source=new pt(e):this.source=e,r?this.decompress=r:this.decompress=re,t?this.cache=t:this.cache=new Ut}getHeader(){return g(this,null,function*(){return yield this.cache.getHeader(this.source)})}getZxyAttempt(e,t,r,n){return g(this,null,function*(){let i=ht(e,t,r),a=yield this.cache.getHeader(this.source);if(a.specVersion<3)return Me.getZxy(a,this.source,this.cache,e,t,r,n);if(e<a.minZoom||e>a.maxZoom)return;let o=a.rootDirectoryOffset,c=a.rootDirectoryLength;for(let u=0;u<=3;u++){let f=yield this.cache.getDirectory(this.source,o,c,a),s=mt(f,i);if(s){if(s.runLength>0){let l=yield this.source.getBytes(a.tileDataOffset+s.offset,s.length,n,a.etag);return{data:yield this.decompress(l.data,a.tileCompression),cacheControl:l.cacheControl,expires:l.expires}}o=a.leafDirectoryOffset+s.offset,c=s.length}else return}throw Error("Maximum directory depth exceeded")})}getZxy(e,t,r,n){return g(this,null,function*(){try{return yield this.getZxyAttempt(e,t,r,n)}catch(i){if(i instanceof ee)return this.cache.invalidate(this.source),yield this.getZxyAttempt(e,t,r,n);throw i}})}getMetadataAttempt(){return g(this,null,function*(){let e=yield this.cache.getHeader(this.source),t=yield this.source.getBytes(e.jsonMetadataOffset,e.jsonMetadataLength,void 0,e.etag),r=yield this.decompress(t.data,e.internalCompression),n=new TextDecoder("utf-8");return JSON.parse(n.decode(r))})}getMetadata(){return g(this,null,function*(){try{return yield this.getMetadataAttempt()}catch(e){if(e instanceof ee)return this.cache.invalidate(this.source),yield this.getMetadataAttempt();throw e}})}getTileJson(e){return g(this,null,function*(){let t=yield this.getHeader(),r=yield this.getMetadata(),n=vt(t.tileType);return{tilejson:"3.0.0",scheme:"xyz",tiles:[`${e}/{z}/{x}/{y}${n}`],vector_layers:r.vector_layers,attribution:r.attribution,description:r.description,name:r.name,version:r.version,bounds:[t.minLon,t.minLat,t.maxLon,t.maxLat],center:[t.centerLon,t.centerLat,t.centerZoom],minzoom:t.minZoom,maxzoom:t.maxZoom}})}};export{dt as Compression,ee as EtagMismatch,pt as FetchSource,zt as FileSource,ve as PMTiles,Lt as Protocol,Mt as ResolvedValueCache,Ut as SharedPromiseCache,gt as TileType,wt as bytesToHeader,mt as findTile,E as getUint64,bt as leafletRasterLayer,O as readVarint,Et as tileIdToZxy,vt as tileTypeExt,ht as zxyToTileId};
//# sourceMappingURL=pmtiles.mjs.map